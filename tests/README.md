# CEDAR Testing Guide

This directory contains all tests for the CEDAR application.

## Testing Philosophy

CEDAR uses a two-tier testing approach:

| Test Type | Location | Data Source | Purpose |
|-----------|----------|-------------|---------|
| **Unit Tests** | `testthat/test-*.R` | Known fixtures | Verify functions return correct values |
| **Integration Tests** | `test-*-standalone.R` | Production data | Verify full pipeline runs without errors |

## Quick Start

```bash
# Run all unit tests
Rscript tests/testthat.R

# Run integration test for dept report
Rscript tests/test-dept-report-standalone.R
```

---

## Unit Tests (testthat)

Unit tests verify that individual functions work correctly with known inputs.

### Running Unit Tests

```bash
# Run all tests
Rscript tests/testthat.R

# Run specific test file
Rscript -e "testthat::test_file('tests/testthat/test-filtering.R')"

# From R console
devtools::test()
```

### Test Files

```
tests/testthat/
├── setup.R                  # Loads fixtures, defines helpers
├── fixtures/
│   ├── known_test_data.R    # Hand-crafted test data (unit tests)
│   └── cedar_*_test.qs      # Schema fixtures (validation)
├── test-filtering.R         # Data filtering tests
├── test-enrollment.R        # Enrollment analysis tests
├── test-headcount.R         # Headcount analysis tests
├── test-grades.R            # Grade analysis tests
└── ...
```

### Two Types of Fixtures

**1. Known Fixtures** (`fixtures/known_test_data.R`)
- Hand-crafted data with predetermined expected values
- Used for behavioral tests with specific assertions
- Version-controlled, never auto-generated

```r
# Example: We KNOW there are exactly 4 HIST sections
expect_equal(nrow(filtered), 4)
```

**2. Schema Fixtures** (`fixtures/cedar_*_test.qs`)
- Sampled from real CEDAR data
- Used for schema validation (correct columns exist)
- Generated by `create-test-fixtures.R`

```r
# Example: Verify column exists, don't assert specific count
expect_true("student_college" %in% colnames(data))
```

### Writing Good Unit Tests

```r
test_that("filter_DESRs filters by HIST department correctly", {
  # Use KNOWN fixtures for specific assertions
  opt <- create_test_opt(list(dept = "HIST"))
  filtered <- filter_DESRs(known_sections, opt)

  # Assert specific expected values (from known_test_data.R comments)
  expect_equal(nrow(filtered), 4)  # We KNOW there are exactly 4 HIST sections
  expect_true(all(filtered$department == "HIST"))
  expect_setequal(filtered$subject_course,
                  c("HIST 1110", "HIST 1120", "HIST 2010", "HIST 3010"))
})
```

---

## Integration Tests (Standalone)

Integration tests verify that the full pipeline runs without errors using real production data.

### Running Integration Tests

```bash
# Run dept report integration test
Rscript tests/test-dept-report-standalone.R
```

### What Integration Tests Validate

- All required data files load correctly
- Functions work together without schema mismatches
- Reports generate without crashing
- Output types are correct (plots are plotly/ggplot, tables are data frames)

### When to Use Integration Tests

- After changing data transformation scripts
- Before deploying to production
- When debugging pipeline issues
- As a smoke test after major changes

---

## Fixture Management

### Regenerating Schema Fixtures

If you change the data transformation, regenerate fixtures:

```bash
# 1. Update transformation
vim R/data-parsers/transform-to-cedar.R

# 2. Regenerate production data
Rscript R/data-parsers/transform-to-cedar.R

# 3. Regenerate test fixtures
Rscript tests/testthat/create-test-fixtures.R

# 4. Run tests to verify
Rscript tests/testthat.R
```

### Updating Known Fixtures

Edit `tests/testthat/fixtures/known_test_data.R` directly. Update the comments documenting expected values.

---

## Docker/Shiny Testing

For Docker container and Shiny app testing, use the shell scripts in the project root:

| Script | Purpose |
|--------|---------|
| `quick-test.sh` | Fast container restart + log check |
| `test-docker-shiny.sh` | Full Docker rebuild + validation |
| `test-docker-shiny-full.sh` | Docker + HTTP endpoint test |

---

## Test Coverage

### Currently Implemented

- **Filtering** (`test-filtering.R`) - Department, term, campus, level, status filters
- **Dept Report** (`test-dept-report-standalone.R`) - Full pipeline integration

### To Be Implemented

- Enrollment analysis (`test-enrollment.R`)
- Headcount analysis (`test-headcount.R`)
- Grade analysis (`test-grades.R`)
- Seatfinder (`test-seatfinder.R`)
- Forecast (`test-forecast.R`)

---

## Best Practices

### Test Independence
Each test should be completely independent. Use fixtures from `setup.R`, don't rely on previous test state.

### Arrange-Act-Assert Pattern
```r
test_that("function does something", {
  # Arrange: Set up test data
  opt <- create_test_opt(list(dept = "HIST"))

  # Act: Call the function
  result <- my_function(known_sections, opt)

  # Assert: Verify results with KNOWN expected values
  expect_equal(nrow(result), 4)
})
```

### Use Known Fixtures for Behavioral Tests
Don't test that "filtering works" - test that "filtering HIST returns exactly 4 rows with specific courses."

### Use Integration Tests for Pipeline Validation
Integration tests catch schema mismatches between components that unit tests miss.

---

## Troubleshooting

### "Column X doesn't exist" errors

This usually means the transformation script and consuming function are out of sync:

1. Check what columns the function expects
2. Check what columns the data has
3. Update `transform-to-cedar.R` if needed
4. Regenerate data and fixtures

### Tests pass but Docker fails

The fixtures might have columns that production data doesn't:

1. Run `Rscript tests/test-dept-report-standalone.R` (uses real data)
2. Fix any schema mismatches in `transform-to-cedar.R`
3. Regenerate production data
4. Regenerate test fixtures

---

## File Reference

| File | Purpose | Keep? |
|------|---------|-------|
| `testthat.R` | Test runner entry point | Yes |
| `test-dept-report-standalone.R` | Integration test | Yes |
| `testthat/setup.R` | Load fixtures, define helpers | Yes |
| `testthat/fixtures/known_test_data.R` | Hand-crafted test data | Yes |
| `testthat/create-test-fixtures.R` | Generate schema fixtures | Yes |
| `testthat/test-*.R` | Unit test files | Yes |
